<script src="//codecloud.cdn.speedyrails.net/sites/5438407c6e6f64462d020000/92b82a88144a6207ab1a5e8e0f63d3d1/craftmap.js"></script>
<style>
    .demo1{
        height:365px;
        margin-bottom:20px;
    }
</style>
<div class="content_container main_container">
    <div id="store_container">
        <script id="store_template" type="x-tmpl-mustache/text">
            <div class="promo_main_header">
                {{name}}
                <div class="store_details_anchors pull-right">
                    <a href="#map">
                        <img src="//codecloud.cdn.speedyrails.net/sites/56c740936e6f642d56000000/image/png/1456507179000/map_icon.png" class="" alt="">
                        <tt>Map</tt>
                    </a>
                    <a id="promo_anchor" href="#promos_main">
                        <img src="//codecloud.cdn.speedyrails.net/sites/56c740936e6f642d56000000/image/png/1456507166000/promo_icon.png" class="" alt="">
                        <tt>Promos (<span></span>)</tt>
                    </a>
                    <a id="job_anchor" href="#jobs_main">
                        <img src="//codecloud.cdn.speedyrails.net/sites/56c740936e6f642d56000000/image/png/1456507192000/jobs_icon.png" class="" alt="jobs icon">
                        <tt>Jobs (<span></span>)</tt>
                    </a>
                </div>
            </div>
            <div class="row">
               <div class="col-md-8">
                    <div id="map">
                        <div class="demo1">
                            <img src="" class="imgMap" id="map_image" alt="Map">                
                        	<div class="marker" id='scroll_to_marker' data-coords="{{map_x_coordinate}}, {{map_y_coordinate}}">
                        	    {{name}}
                            </div>
                        </div>   
                    </div>
                    <div class="store_details_desc">{{{rich_description}}}</div>
                </div>
                <div class="col-md-4">
                    <img src="{{alt_store_front_url}}" class="store_logo hidden_phone" alt="{{name}}" />
                    <div class="side_stores">
                        <a href="tel:{{phone}}" style="{{phone_show}}">{{phone}}</a>
                        <br style="{{phone_show}}" />
                        <a href="//{{website}}" target="_blank" style="{{show}}">Visit Website</a>
                    </div>
                </div> 
            </div>
        </script>
    </div>
    <div class="row">
        <div class="col-md-8 promo_item" id="promos_main">
            <h2 class="store_details_promo_heading">
                <img src="//codecloud.cdn.speedyrails.net/sites/56c740936e6f642d56000000/image/png/1456507166000/promo_icon.png" class="" alt="promo icon">
                Promotions
            </h2>
            <div id="promos_container">
                <script id="promos_template" type="x-tmpl-mustache/text">
                    <div class="row promo_item cats_row" data-cat="{{cat_list}}">
                        <div class="col-md-5">
                            <img class="promo_store_image" src="{{image_url}}" alt="{{name}}" />
                        </div>
                        <div class="col-md-7">
                            <h2 class="promo_list_name">{{name}}</h2>
                            <p>
                                <span class="promo_dates">{{dates}}</span>
                            </p>
                            <div class="promo_list_desc">{{description_short}}</div>
                            <a class="read_more" href="/promotions/{{slug}}">Read More</a>
                        </div>
                    </div>
                </script>
            </div>
        </div>
        <div class="col-md-8 promo_item" id="jobs_main">
            <h2 class="store_details_promo_heading">
                <img src="//codecloud.cdn.speedyrails.net/sites/56c740936e6f642d56000000/image/png/1456507192000/jobs_icon.png" class="" alt="jobs icon">
                Jobs
            </h2>
            <div id="jobs_container">
                <script id="jobs_template" type="x-tmpl-mustache/text">
                    <div class="row promo_item" data-cat="{{cat_list}}">
                        <div class="col-md-12">
                            <h2 class="promo_list_name">{{name}}</h2>
                            <p>
                                <span class="promo_store">{{store_name}}</span>
                                <span class="promo_store">{{job_type}}</span>
                                <span class="promo_dates">{{published_on}}</span>
                            </p>
                            <div class="promo_list_desc">{{description_short}}</div>
                            <a class="read_more" href="/jobs/{{slug}}">Read More</a>
                        </div>
                    </div>
                </script>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function(e){
        init(e);
        function renderAll (){
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            var store_details = getStoreDetailsBySlug(slug);
            renderStoreDetails("#store_container","#store_template", store_details, slug);
            
            var store_promo_ids = store_details.promotions
            var store_promos = getPromotionsForIds(store_promo_ids).sortBy(function(o){ return o.start_date });
            var published_promos = [];
            $.each( store_promos , function( key, val ){
                today = moment();
                webDate = moment(val.show_on_web_date);
                if (today.tz(site_json.time_zone) >= webDate.tz(site_json.time_zone)) {
                    published_promos.push(val)
                }
            });
            if( published_promos.length > 0){
                renderPromotions("#promos_container","#promos_template", published_promos);
                $('#promo_anchor span').text(published_promos.length)
            } else {
                $('#promos_main').hide()
                $('#promo_anchor').hide()
            }
            
            var store_job_ids = store_details.jobs
            var store_jobs = getJobsForIds(store_job_ids).sortBy(function(o){ return o.start_date });
            var published_jobs = [];
            $.each( store_jobs , function( key, val ){
                today = moment();
                webDate = moment(val.show_on_web_date);
                if (today.tz(site_json.time_zone) >= webDate.tz(site_json.time_zone)) {
                    published_jobs.push(val)
                } 
            });
            if( published_jobs.length > 0){
                renderJobs('#jobs_container', '#jobs_template', published_jobs);
                $('#job_anchor span').text(published_jobs.length)
            } else {
                $('#jobs_main').hide();
                $('#job_anchor').hide()
            }
            
            show_content();
            
            $("#map_image").attr("src", getPNGMapURL());
            var dimension = (store_details.x_coordinate - 460 )  + " " + (store_details.y_coordinate - 230);
            $('.demo1').craftmap({
                image: {
        			width: 1690,
    				height: 800,
    				name: 'imgMap'
    			},
    			map: {
    				position: dimension
    			}
    		});
            $("#anchor_id").click();
           	$("#scroll_to_marker").click();
        }
        
		loadMallDataCached(renderAll); 
    })
</script>